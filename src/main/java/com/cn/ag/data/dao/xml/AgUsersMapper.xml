<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cn.ag.data.dao.interf.AgUsersMapper">

	<resultMap
			id="BaseResultMap"
			type="com.cn.ag.data.domain.sd.AgUsers">
		<id
				column="id"
				property="id"
				jdbcType="BIGINT"/>
		<result
				column="user_name"
				property="userName"
				jdbcType="VARCHAR"/>
		<result
				column="password"
				property="password"
				jdbcType="VARCHAR"/>
		<result
				column="fullname"
				property="fullname"
				jdbcType="VARCHAR"/>
		<result
				column="phone"
				property="phone"
				jdbcType="VARCHAR"/>
		<result
				column="token"
				property="token"
				jdbcType="VARCHAR"/>
		<result
				column="reg_time"
				property="regTime"
				jdbcType="BIGINT"/>
		<result
				column="last_login_time"
				property="lastLoginTime"
				jdbcType="BIGINT"/>
		<result
				column="stat"
				property="stat"
				jdbcType="INTEGER"/>
		<result
				column="role_ids"
				property="roleIds"
				jdbcType="VARCHAR"/>
		<result
				column="user_code"
				property="userCode"
				jdbcType="VARCHAR"/>
		<result
				column="store_ids"
				property="storeIds"
				jdbcType="VARCHAR"/>
		<result
				column="dealer_id"
				property="dealerId"
				jdbcType="BIGINT"/>
		<result
				column="responsible_area_ids"
				property="responsibleAreaIds"
				jdbcType="VARCHAR"/>
		<result
				column="dd_user_id"
				property="ddUserId"
				jdbcType="VARCHAR"/>
		<result
				column="creator_id"
				property="creatorId"
				jdbcType="BIGINT"/>
		<result
				column="responsible_dealer_type"
				property="responsibleDealerType"
				jdbcType="INTEGER"/>
		<result
				column="is_myself_operation"
				property="isMyselfOperation"
				jdbcType="INTEGER"/>
		<result
				column="position"
				property="position"
				jdbcType="VARCHAR"/>
	</resultMap>

	<sql id="Base_Column_List">
		id, user_name, password, fullname, phone, token, reg_time,
		last_login_time, stat,
		role_ids, user_code, store_ids, dealer_id,
		responsible_area_ids, dd_user_id,
		creator_id,
		responsible_dealer_type,
		is_myself_operation,position
	</sql>
	<select
		id="selectByPrimaryKey"
		resultMap="BaseResultMap"
		parameterType="java.lang.Long">
		select
		<include refid="Base_Column_List" />
		from ag_users
		where id = #{id,jdbcType=BIGINT}
	</select>
	<delete
		id="deleteByPrimaryKey"
		parameterType="java.lang.Long">
		delete from ag_users
		where id = #{id,jdbcType=BIGINT}
	</delete>
	<insert
		id="insert"
		parameterType="com.cn.ag.data.domain.sd.AgUsers">
		insert into ag_users (id, user_name, password,
		fullname,
		phone, token,
		reg_time, last_login_time, stat,
		role_ids, user_code,
		store_ids,
		dealer_id, responsible_area_ids, dd_user_id,
		creator_id,
		responsible_dealer_type, is_myself_operation,position
		)
		values
		(#{id,jdbcType=BIGINT}, #{userName,jdbcType=VARCHAR},
		#{password,jdbcType=VARCHAR},
		#{fullname,jdbcType=VARCHAR},
		#{phone,jdbcType=VARCHAR}, #{token,jdbcType=VARCHAR},
		#{regTime,jdbcType=BIGINT}, #{lastLoginTime,jdbcType=BIGINT},
		#{stat,jdbcType=INTEGER},
		#{roleIds,jdbcType=VARCHAR},
		#{userCode,jdbcType=VARCHAR}, #{storeIds,jdbcType=VARCHAR},
		#{dealerId,jdbcType=BIGINT}, #{responsibleAreaIds,jdbcType=VARCHAR},
		#{ddUserId,jdbcType=VARCHAR},
		#{creatorId,jdbcType=BIGINT},
		#{responsibleDealerType,jdbcType=INTEGER},
		#{isMyselfOperation,jdbcType=INTEGER}, #{position,jdbcType=VARCHAR}
		)
	</insert>
	<insert
		id="insertSelective"
		useGeneratedKeys="true"
		keyProperty="id"
		parameterType="com.cn.ag.data.domain.sd.AgUsers">
		insert into ag_users
		<trim
			prefix="("
			suffix=")"
			suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="userName != null">
				user_name,
			</if>
			<if test="password != null">
				password,
			</if>
			<if test="fullname != null">
				fullname,
			</if>
			<if test="phone != null">
				phone,
			</if>
			<if test="token != null">
				token,
			</if>
			<if test="regTime != null">
				reg_time,
			</if>
			<if test="lastLoginTime != null">
				last_login_time,
			</if>
			<if test="stat != null">
				stat,
			</if>
			<if test="userCode != null">
				user_code,
			</if>
			<if test="dealerId != null">
				dealer_id,
			</if>
			<if test="responsibleAreaIds != null">
				responsible_area_ids,
			</if>
			<if test="ddUserId != null">
				dd_user_id,
			</if>
			<if test="creatorId != null">
				creator_id,
			</if>
			<if test="responsibleDealerType != null">
				responsible_dealer_type,
			</if>
			<if test="isMyselfOperation != null">
				is_myself_operation,
			</if>
			<if test="position != null">
				position,
			</if>
		</trim>
		<trim
			prefix="values ("
			suffix=")"
			suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=BIGINT},
			</if>
			<if test="userName != null">
				#{userName,jdbcType=VARCHAR},
			</if>
			<if test="password != null">
				#{password,jdbcType=VARCHAR},
			</if>
			<if test="fullname != null">
				#{fullname,jdbcType=VARCHAR},
			</if>
			<if test="phone != null">
				#{phone,jdbcType=VARCHAR},
			</if>
			<if test="token != null">
				#{token,jdbcType=VARCHAR},
			</if>
			<if test="regTime != null">
				#{regTime,jdbcType=BIGINT},
			</if>
			<if test="lastLoginTime != null">
				#{lastLoginTime,jdbcType=BIGINT},
			</if>
			<if test="stat != null">
				#{stat,jdbcType=INTEGER},
			</if>
			<if test="userCode != null">
				#{userCode,jdbcType=VARCHAR},
			</if>
			<if test="dealerId != null">
				#{dealerId,jdbcType=BIGINT},
			</if>
			<if test="responsibleAreaIds != null">
				#{responsibleAreaIds,jdbcType=VARCHAR},
			</if>
			<if test="ddUserId != null">
				#{ddUserId,jdbcType=VARCHAR},
			</if>
			<if test="creatorId != null">
				#{creatorId,jdbcType=BIGINT},
			</if>
			<if test="responsibleDealerType != null">
				#{responsibleDealerType,jdbcType=INTEGER},
			</if>
			<if test="isMyselfOperation != null">
				#{isMyselfOperation,jdbcType=INTEGER},
			</if>
			<if test="position != null">
				#{position,jdbcType=VARCHAR},
			</if>
			
		</trim>
	</insert>
	<update
		id="updateByPrimaryKeySelective"
		parameterType="com.cn.ag.data.domain.sd.AgUsers">
		update ag_users
		<set>
			<if test="userName != null">
				user_name = #{userName,jdbcType=VARCHAR},
			</if>
			<if test="password != null">
				password = #{password,jdbcType=VARCHAR},
			</if>
			<if test="fullname != null">
				fullname = #{fullname,jdbcType=VARCHAR},
			</if>
			<if test="phone != null">
				phone = #{phone,jdbcType=VARCHAR},
			</if>
			<if test="token != null">
				token = #{token,jdbcType=VARCHAR},
			</if>
			<if test="regTime != null">
				reg_time = #{regTime,jdbcType=BIGINT},
			</if>
			<if test="lastLoginTime != null">
				last_login_time = #{lastLoginTime,jdbcType=BIGINT},
			</if>
			<if test="stat != null">
				stat = #{stat,jdbcType=INTEGER},
			</if>
			<if test="userCode != null">
				user_code = #{userCode,jdbcType=VARCHAR},
			</if>
			<if test="dealerId != null">
				dealer_id = #{dealerId,jdbcType=BIGINT},
			</if>
			<if test="responsibleAreaIds != null">
				responsible_area_ids =
				#{responsibleAreaIds,jdbcType=VARCHAR},
			</if>
			<if test="ddUserId != null">
				dd_user_id = #{ddUserId,jdbcType=VARCHAR},
			</if>
			<if test="creatorId != null">
				creator_id = #{creatorId,jdbcType=BIGINT},
			</if>
			<if test="responsibleDealerType != null">
				responsible_dealer_type =
				#{responsibleDealerType,jdbcType=INTEGER},
			</if>
			<if test="isMyselfOperation != null">
				is_myself_operation =
				#{isMyselfOperation,jdbcType=INTEGER},
			</if>
			<if test="position != null">
				position =
				#{position,jdbcType=VARCHAR},
			</if>
		</set>
		where id = #{id,jdbcType=BIGINT}
	</update>
	<update
		id="updateByPrimaryKey"
		parameterType="com.cn.ag.data.domain.sd.AgUsers">
		update ag_users
		set user_name =
		#{userName,jdbcType=VARCHAR},
		password = #{password,jdbcType=VARCHAR},
		fullname = #{fullname,jdbcType=VARCHAR},
		phone =
		#{phone,jdbcType=VARCHAR},
		token = #{token,jdbcType=VARCHAR},
		reg_time =
		#{regTime,jdbcType=BIGINT},
		last_login_time =
		#{lastLoginTime,jdbcType=BIGINT},
		stat = #{stat,jdbcType=INTEGER},
		role_ids = #{roleIds,jdbcType=VARCHAR},
		user_code =
		#{userCode,jdbcType=VARCHAR},
		store_ids = #{storeIds,jdbcType=VARCHAR},
		dealer_id = #{dealerId,jdbcType=BIGINT},
		responsible_area_ids =
		#{responsibleAreaIds,jdbcType=VARCHAR},
		dd_user_id =
		#{ddUserId,jdbcType=VARCHAR},
		creator_id =
		#{creatorId,jdbcType=BIGINT},
		responsible_dealer_type =
		#{responsibleDealerType,jdbcType=INTEGER},
		is_myself_operation =
		#{isMyselfOperation,jdbcType=INTEGER},
			position =
		#{position,jdbcType=VARCHAR},
		where id = #{id,jdbcType=VARCHAR}
	</update>


	<!-- 自定义 -->
	<!-- 按User条件查询 -->
	<select
		id="selectPrimaryKeySelective"
		parameterType="com.cn.ag.data.domain.sd.AgUsers"
		resultMap="ExpandResultMap_A">
		select
		<include refid="Base_Column_List" />
		from
		ag_users
		where 1=1

		<if test="userName != null">
			and user_name = #{userName,jdbcType=VARCHAR}
		</if>
		<if test="password != null">
			and password = #{password,jdbcType=VARCHAR}
		</if>
		<if test="fullname != null">
			and fullname = #{fullname,jdbcType=VARCHAR}
		</if>
		<if test="phone != null">
			and phone = #{phone,jdbcType=VARCHAR}
		</if>
		<if test="stat != null">
			and stat = #{stat,jdbcType=INTEGER}
		</if>
		<if test="dealerId != null">
			and dealer_id = #{dealerId,jdbcType=BIGINT}
		</if>
			<if test="position != null">
			and position =
			#{position,jdbcType=VARCHAR}
		</if>
		<if test="id != null">
			and id = #{id,jdbcType=BIGINT}
		</if>
	</select>
	<!-- 根据名字查询返回User -->
	<select
		id="selectByUserName"
		resultType="com.cn.ag.data.domain.sd.AgUsers"
		parameterType="java.lang.String">
		select
		<include refid="Base_Column_List" />
		from ag_users
		where user_name = #{userName,jdbcType=VARCHAR}
	</select>


	<!-- 统计查询总数 -->
	<select
		id="getDataTotalOfContions"
		parameterType="java.util.Map"
		resultType="java.lang.Integer">
		select
		count(id)
		from ag_users
		where 1=1  and stat=1

		<choose>
			<when test="whereParam!=null">
				${whereParam}
			</when>
			<otherwise>
				<if test="user!=null and user.id!=null">
					and id=#{user.id,jdbcType=BIGINT}
				</if>
			</otherwise>
		</choose>
	</select>













	<!-- 统计User视图 -->

	<select
		id="selectListAgUsers"
		resultMap="BaseResultMap">
		select * from ag_users where id in
		<foreach
			collection="array"
			item="id"
			index="index"
			open="("
			close=")"
			separator=",">
			#{id}
		</foreach>
	</select>
	<select
		id="getListResident"
		resultMap="BaseResultMap">
	 SELECT ag_users.* FROM qx_user_role_authorization LEFT JOIN ag_users ON  qx_user_role_authorization.user_id=ag_users.id AND qx_user_role_authorization.factory_id IS NOT NULL
    LEFT JOIN  ag_users_roles
    ON ag_users.id = ag_users_roles.users_id
WHERE 1=1
    AND ag_users_roles.roles_id = 1
		<if test="whereParam!=null">
			${whereParam}
		</if>
		<if
			test="fparam != null and fparam.startIndex!=null and fparam.endIndex!=null">
			limit
			#{fparam.startIndex,jdbcType=INTEGER},#{fparam.endIndex,jdbcType=INTEGER}
		</if>
	</select>

	<select
		id="getListResidentNum"
		parameterType="java.util.Map"
		resultType="java.lang.Integer">
		 SELECT COUNT(ag_users.id) FROM qx_user_role_authorization LEFT JOIN ag_users ON  qx_user_role_authorization.user_id=ag_users.id AND qx_user_role_authorization.factory_id IS NOT NULL
    LEFT JOIN  ag_users_roles
    ON ag_users.id = ag_users_roles.users_id
WHERE 1=1
    AND ag_users_roles.roles_id = 1
		<if test="whereParam!=null">
			${whereParam}
		</if>
	</select>

	<select
		id="getListResidents"
		resultMap="BaseResultMap">
		 SELECT ag_users.* FROM qx_user_role_authorization LEFT JOIN ag_users ON  qx_user_role_authorization.user_id=ag_users.id AND qx_user_role_authorization.factory_id IS NOT NULL
    LEFT JOIN  ag_users_roles
    ON ag_users.id = ag_users_roles.users_id
WHERE 1=1 AND (ag_users_roles.roles_id = 1 AND
		ag_users.is_myself_operation=1 OR
		ag_users_roles.roles_id=19 OR ag_users_roles.roles_id=23) 
		<if test="whereParam!=null">
			${whereParam}
		</if>
		<if
			test="fparam != null and fparam.startIndex!=null and fparam.endIndex!=null">
			limit
			#{fparam.startIndex,jdbcType=INTEGER},#{fparam.endIndex,jdbcType=INTEGER}
		</if>
	</select>
	<select
		id="getListResidentNums"
		parameterType="java.util.Map"
		resultType="java.lang.Integer">
		 SELECT count(ag_users.id) FROM qx_user_role_authorization LEFT JOIN ag_users ON  qx_user_role_authorization.user_id=ag_users.id AND qx_user_role_authorization.factory_id IS NOT NULL
    LEFT JOIN  ag_users_roles
    ON ag_users.id = ag_users_roles.users_id
WHERE 1=1 AND (ag_users_roles.roles_id = 1 AND
		ag_users.is_myself_operation=1 OR
		ag_users_roles.roles_id=19 OR ag_users_roles.roles_id=23) 
		<if test="whereParam!=null">
			${whereParam}
		</if>
	</select>
	
	<select id="selectAgUsersIn" resultMap="BaseResultMap">
		SELECT a.user_name FROM ag_users a LEFT JOIN ag_users_roles ar ON a.id=ar.users_id WHERE ar.roles_id IN (8,1,3,4,10,12,14,15,18,19,20,22,23,24,26,27)
	</select>
	
	<select
		id="selectPhone"
		resultMap="BaseResultMap"
		parameterType="java.lang.String">
		select
		<include refid="Base_Column_List" />
		from ag_users
		where phone = #{userName,jdbcType=VARCHAR}
	</select>
	
	 <!-- 自定义 -->
  <select id="selectQxUserByNameAndPass" parameterType="com.cn.ag.data.domain.sd.AgUsers" resultMap="BaseResultMap">
  	select <include refid="Base_Column_List"></include> from ag_users
  	<where>
  		1=2	
  		<if test="userName != null and password != null">
  			or (user_name = #{userName,jdbcType=VARCHAR} and password = #{password,jdbcType=VARCHAR})
  		</if>
  	</where>
  </select>
  


	<select id="selectDealerId" parameterType="java.lang.String" resultMap="BaseResultMap">
		select*from ag_users where dealer_id=#{id} and stat not in (2)
	</select>
	
	<select id="selectFullNameById" parameterType="long" resultType="java.lang.String">
		select fullname from ag_users where id = #{id}
	</select>
	
	<select id="selectAgUsersFullNameByddid" parameterType="java.lang.String" resultMap="BaseResultMap">
		select fullname from ag_users where dd_user_id = #{ddid}
	</select>
	<select id="selectShopownerDdIdByOrderCode" parameterType="java.lang.String" resultMap="BaseResultMap">
		SELECT
			<include refid="Base_Column_List"/>
		FROM
			ag_users
		WHERE
				id IN (
				SELECT
					users_id
				FROM
					ag_users_roles
				WHERE
						users_id IN (
						SELECT
							users_id
						FROM
							ag_users_store
						WHERE
								store_id IN ( SELECT store_id FROM `ag_order` WHERE order_code = #{orderCode,jdbcType=VARCHAR} ))
				  AND roles_id = 9)
	</select>
	<select id="selectByDealerIdAndPhone" parameterType="java.lang.String" resultMap="BaseResultMap">
		SELECT
			<include refid="Base_Column_List" />
		FROM
			ag_users
		WHERE
				user_name = (
				SELECT
					phone
				FROM
					ag_dealer_body
				WHERE
					id = #{id},jdbcType=VARCHAR)
	</select>
	<select id="selectStoreManager" parameterType="java.lang.Long" resultMap="BaseResultMap">
		select * from ag_users
		where stat = 1 and id in (
		  select s.users_id from (select users_id from ag_users_store where store_id = 1) s
		  inner join (select users_id from ag_users_roles where roles_id = 9 ) r
		  on s.users_id = r.users_id
		)
	</select>

	<!-- 2019/11/14 更新迭代 -->
	<resultMap id="ExpandResultMap_A" type="com.cn.ag.data.domain.sd.AgUsers" extends="BaseResultMap">
		<collection property="role" ofType="com.cn.ag.data.domain.sd.AgRoles"
					column="id" select="com.cn.ag.data.dao.interf.AgUsersRolesMapper.selectRoleByUseId"/>
		<collection property="store" javaType="java.util.List" ofType="com.cn.ag.data.domain.sd.AgStore"
					column="id" select="com.cn.ag.data.dao.interf.AgUsersStoreMapper.selectStoreByUserId"/>
		<collection property="dealer" ofType="com.cn.ag.data.domain.sd.AgDealerBody"
					column="dealer_id" select="com.cn.ag.data.dao.interf.AgDealerBodyMapper.selectByPrimaryKey"/>
	</resultMap>


</mapper>